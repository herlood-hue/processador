<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Processador de Planilhas v11.5 (Otimizado)</title>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>
    <style>
        /* CSS Mantido id√™ntico √† v11.4 */
        :root { --color-background-light: #f0f4f8; --color-background-card: white; --color-text-primary: #1a202c; --color-text-secondary: #334e68; --color-text-tertiary: #718096; --color-border: #e2e8f0; --color-button-primary: #4c7cff; --color-button-success: #48bb78; --color-button-danger: #e53e3e; --color-button-warning: #d69e2e; --color-table-header-bg: #f7fafc; --color-icon-mode: #ffc107; --highlight-bg: #fffaf0; --highlight-border: #fbd38d; }
        body.dark-mode { --color-background-light: #1a202c; --color-background-card: #2d3748; --color-text-primary: #edf2f7; --color-text-secondary: #a0aec0; --color-text-tertiary: #718096; --color-border: #4a5568; --color-button-primary: #63b3ed; --color-button-success: #68d391; --color-button-danger: #fc8181; --color-table-header-bg: #4a5568; --color-icon-mode: #f7fafc; --highlight-bg: #2c261e; --highlight-border: #b7791f; }
        body { font-family: 'Inter', sans-serif; margin: 0; padding: 2rem; background-color: var(--color-background-light); color: var(--color-text-secondary); display: flex; justify-content: center; align-items: flex-start; min-height: 100vh; }
        .main-container { display: flex; gap: 2rem; max-width: 1400px; width: 100%; flex-wrap: wrap; }
        .card-container { background-color: var(--color-background-card); padding: 2rem; border-radius: 1rem; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05); display: flex; flex-direction: column; gap: 1.5rem; flex: 1; min-width: 300px; }
        .left-panel { flex-basis: 30%; } .right-panel { flex-basis: 65%; display: none; }
        h1 { font-size: 1.5rem; text-align: center; flex-grow: 1; color: var(--color-text-primary); margin: 0; }
        .header-content { display: flex; justify-content: space-between; align-items: center; }
        #darkModeToggleIcon { font-size: 2rem; cursor: pointer; color: var(--color-icon-mode); }
        .link-opener-group { display: flex; gap: 0.75rem; justify-content: center; margin-bottom: 1rem; }
        .link-opener-group button { padding: 0.3rem 0.8rem; font-size: 0.85rem; background-color: var(--color-button-primary); color: white; border: none; border-radius: 0.4rem; cursor: pointer; }
        .form-group { display: flex; flex-direction: column; gap: 0.5rem; margin-bottom: 1rem; }
        .highlight-section { background-color: var(--highlight-bg); border: 1px dashed var(--highlight-border); padding: 1rem; border-radius: 0.5rem; }
        .upload-row { display: flex; gap: 1rem; align-items: flex-end; }
        .file-input-wrapper { position: relative; width: 100%; }
        .file-input-wrapper input[type=file] { position: absolute; left: 0; top: 0; opacity: 0; cursor: pointer; width: 100%; height: 100%; }
        .file-label { background-color: var(--color-button-primary); color: white; font-weight: 600; text-align: center; display: block; padding: 0.75rem 1rem; border-radius: 0.5rem; }
        .file-label.warning-bg { background-color: var(--color-button-warning); }
        .message-box { background-color: var(--color-message-info-bg); border: 1px solid var(--color-message-info-border); border-radius: 0.5rem; padding: 1rem; text-align: center; }
        .button-group { display: flex; gap: 0.75rem; justify-content: flex-end; margin-bottom: 1rem; }
        .copy-button, .clear-button { padding: 0.75rem 1.5rem; border: none; border-radius: 0.5rem; font-weight: 600; cursor: pointer; color: white; }
        #exportXLSButton, #copyAllButton { background-color: var(--color-button-success); }
        .clear-button { background-color: var(--color-button-danger); }
        .upload-row .copy-button { background-color: var(--color-button-primary); }
        .table-wrapper { overflow-x: auto; border: 1px solid var(--color-border); border-radius: 0.5rem; }
        table { width: 100%; border-collapse: collapse; white-space: nowrap; }
        th, td { padding: 1rem; border-bottom: 1px solid var(--color-border); text-align: left; }
        thead { background-color: var(--color-table-header-bg); }
        td:nth-child(9) { font-weight: bold; color: #d69e2e; }
    </style>
</head>
<body>

<div class="main-container">
    <div class="card-container left-panel">
        <div class="header-content">
            <h1>Processador v11.5</h1>
            <span id="darkModeToggleIcon">üåô</span>
        </div>

        <div class="link-opener-group">
            <button id="openSitesButton">Abrir Sites</button>
            <button id="openSheetsButton">Abrir Planilhas</button>
        </div>

        <div class="input-area">
            <div class="form-group highlight-section">
                <label style="color: var(--color-button-warning);">üìÅ Base de SKUs (Localiza√ß√£o)</label>
                <div class="upload-row">
                    <div class="file-input-wrapper">
                        <label for="locationFileInput" class="file-label warning-bg" id="locationFileLabel">Carregar Base</label>
                        <input type="file" id="locationFileInput" accept=".csv, .xlsx, .xls">
                    </div>
                </div>
            </div>

            <div class="form-group">
                <label>Shopee</label>
                <div class="upload-row">
                    <div class="file-input-wrapper">
                        <label for="shopeeFileInput" class="file-label" id="shopeeFileLabel">Escolher Arquivo</label>
                        <input type="file" id="shopeeFileInput" accept=".csv, .xlsx, .xls" multiple>
                    </div>
                    <button class="copy-button" id="copyShopeeButton">Copiar</button>
                </div>
            </div>

            <div class="form-group">
                <label>Mercado Livre</label>
                <div class="upload-row">
                    <div class="file-input-wrapper">
                        <label for="mercadolivreFileInput" class="file-label" id="mercadolivreFileLabel">Escolher Arquivo</label>
                        <input type="file" id="mercadolivreFileInput" accept=".csv, .xlsx, .xls" multiple>
                    </div>
                    <button class="copy-button" id="copyMercadoLivreButton">Copiar</button>
                </div>
            </div>

            <div class="form-group">
                <label>Amazon</label>
                <div class="upload-row">
                    <div class="file-input-wrapper">
                        <label for="amazonFileInput" class="file-label" id="amazonFileLabel">Escolher Arquivo</label>
                        <input type="file" id="amazonFileInput" accept=".csv, .xlsx, .xls" multiple>
                    </div>
                    <button class="copy-button" id="copyAmazonButton">Copiar</button>
                </div>
            </div>
            
            <div class="form-group">
                <label>Estante Virtual</label>
                <div class="upload-row">
                    <div class="file-input-wrapper">
                        <label for="estanteFileInput" class="file-label" id="estanteFileLabel">Escolher Arquivo</label>
                        <input type="file" id="estanteFileInput" accept=".csv, .xlsx, .xls" multiple>
                    </div>
                    <button class="copy-button" id="copyEstanteButton">Copiar</button>
                </div>
            </div>
            
            <p class="message-box" id="messageBox">Pronto para processar.</p>
        </div>
    </div>
    
    <div class="card-container right-panel" id="resultsPanel">
        <div class="button-group">
            <button class="clear-button" id="clearButton">Limpar</button>
            <button class="copy-button" id="exportXLSButton">Salvar XLS</button>
            <button class="copy-button" id="copyAllButton">Copiar Tudo</button>
        </div>
        <div class="table-wrapper">
            <table>
                <thead>
                    <tr>
                        <th>Site</th>
                        <th>ID Pedido</th>
                        <th>Produto (R$)</th>
                        <th>Frete (R$)</th>
                        <th>Total (R$)</th>
                        <th>Nome Produto</th>
                        <th>Status</th>
                        <th>C√≥d.</th>
                        <th>SKU / Local</th>
                        <th>L√≠quido</th>
                    </tr>
                </thead>
                <tbody id="dataTableBody"></tbody>
            </table>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        let skuLocationMap = new Map();
        const dataTableBody = document.getElementById('dataTableBody');
        const resultsPanel = document.getElementById('resultsPanel');
        const messageBox = document.getElementById('messageBox');

        // --- Helpers de Formata√ß√£o e Parsing ---
        const formatNumber = (val) => {
            if (val === '' || val == null) return '';
            const num = typeof val === 'string' ? parseFloat(val.replace(',', '.')) : val;
            return isNaN(num) ? val : num.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        };

        const parseMoney = (val) => parseFloat(String(val || '0').replace(',', '.')) || 0;
        const parseString = (val) => String(val || '').trim();

        // --- Dark Mode ---
        const darkModeToggleIcon = document.getElementById('darkModeToggleIcon');
        darkModeToggleIcon.onclick = () => {
            document.body.classList.toggle('dark-mode');
            darkModeToggleIcon.innerHTML = document.body.classList.contains('dark-mode') ? '‚òÄÔ∏è' : 'üåô';
        };

        // --- L√≥gica de SKU / Localiza√ß√£o ---
        document.getElementById('locationFileInput').onchange = (e) => {
            if (!e.target.files[0]) return;
            const reader = new FileReader();
            reader.onload = (ev) => {
                const wb = XLSX.read(new Uint8Array(ev.target.result), { type: 'array' });
                const rows = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]], { header: 1 });
                let skuIdx = -1, locIdx = -1;
                
                // Busca din√¢mica de colunas
                for(let row of rows) {
                    if (row && row.includes('SKU') && row.includes('C√≥d. Interno')) {
                        skuIdx = row.indexOf('SKU'); locIdx = row.indexOf('C√≥d. Interno');
                        break;
                    }
                }
                
                if (skuIdx !== -1) {
                    rows.forEach(r => { 
                        if(r[skuIdx]) skuLocationMap.set(parseString(r[skuIdx]), parseString(r[locIdx])); 
                    });
                    document.getElementById('locationFileLabel').innerText = `${skuLocationMap.size} SKUs OK`;
                }
                e.target.value = ''; 
            };
            reader.readAsArrayBuffer(e.target.files[0]);
        };

        const getSkuOrLocation = (sku) => {
            const s = parseString(sku);
            return skuLocationMap.has(s) ? skuLocationMap.get(s) : s;
        };

        // --- Estrat√©gias de Processamento por Plataforma ---
        const strategies = {
            shopee: (rows) => {
                const results = [];
                const orders = {};
                for (let i = 1; i < rows.length; i++) {
                    const col = rows[i];
                    if (!col || !col[0]) continue;
                    const id = parseString(col[0]);

                    if (!orders[id]) {
                        orders[id] = { 
                            p: 0, q: 0, items: [], names: [], 
                            // Taxas AO (40) e AQ (42) da primeira linha do pedido
                            taxa: parseMoney(col[40]) + parseMoney(col[42])
                        };
                    }
                    const p = parseMoney(col[18]), q = parseInt(col[16] || 1);
                    orders[id].p += (p * q); 
                    orders[id].q += q;
                    orders[id].names.push(col[11]);
                    
                    let skuStr = col[12] ? getSkuOrLocation(col[12]) : (col[13] || 'S/ SKU');
                    orders[id].items.push(`${skuStr} (x${q})`);
                }
                
                Object.keys(orders).forEach(id => {
                    const o = orders[id];
                    const skuDisp = o.items.length > 1 
                        ? `COM ${o.items.length}<br>${o.items.join('<br>')}` 
                        : (o.q > 1 ? `QUANTIDADE ${o.q}` : o.items[0].replace(' (x1)', ''));
                    
                    results.push({ site: 'SH', id, prod: o.p, frete: 0, total: o.p, nome: o.names.join('; '), status: 'PAGO', cod: 'SH', sku: skuDisp, liq: (o.p - o.taxa) });
                });
                return results;
            },

            mercadolivre: (rows) => {
                const results = [];
                const orders = {};
                for (let i = 6; i < rows.length; i++) {
                    const col = rows[i];
                    if (!col || !col[0]) continue;
                    const id = parseString(col[0]);
                    
                    if (!orders[id]) orders[id] = { p: 0, c: 0, names: [], sku: col[19] };
                    orders[id].p += parseMoney(col[7]);
                    orders[id].c += parseMoney(col[16]);
                    orders[id].names.push(col[22]);
                }
                
                Object.keys(orders).forEach(id => {
                    const o = orders[id];
                    results.push({ site: 'ML', id, prod: o.p, frete: 0, total: o.p, nome: o.names.join(';'), status: 'PAGO', cod: 'ML', sku: getSkuOrLocation(o.sku), liq: o.c });
                });
                return results;
            },

            amazon: (rows) => {
                const results = [];
                for (let i = 1; i < rows.length; i++) {
                    const col = rows[i];
                    if (!col || !col[0]) continue;
                    const total = parseMoney(col[16]);
                    const prod = parseMoney(col[32]);
                    results.push({ 
                        site: 'AZ', id: col[0], prod: prod, frete: (total - prod), total: total, 
                        nome: col[28], status: 'PAGO', cod: 'AZ', sku: getSkuOrLocation(col[29]), liq: (total * 0.85) 
                    });
                }
                return results;
            },

            estante: (rows) => {
                const results = [];
                const orders = {};
                for (let i = 1; i < rows.length; i++) {
                    const col = rows[i]; 
                    if (!col || !col[3]) continue; // Coluna D: Pedido
                    const id = parseString(col[3]);
                    
                    if (!orders[id]) orders[id] = { p: 0, f: parseMoney(col[28]), skus: [], names: [] };
                    orders[id].p += parseMoney(col[30]);
                    orders[id].names.push(col[7]);
                    const skuMatch = col[10] ? col[10].match(/SKU: (\d+)/) : null;
                    orders[id].skus.push(getSkuOrLocation(skuMatch ? skuMatch[1] : 'S/ SKU'));
                }
                
                Object.keys(orders).forEach(id => {
                    const o = orders[id];
                    const skuDisp = o.skus.length > 1 ? `COM ${o.skus.length}<br>${o.skus.join('<br>')}` : o.skus[0];
                    results.push({ site: 'EV', id, prod: o.p, frete: o.f, total: (o.p + o.f), nome: o.names.join('; '), status: 'PAGO', cod: 'EV', sku: skuDisp, liq: '' });
                });
                return results;
            }
        };

        // --- Manipula√ß√£o de Arquivos ---
        const inputs = ['shopee', 'mercadolivre', 'amazon', 'estante'];
        inputs.forEach(p => {
            const input = document.getElementById(`${p}FileInput`);
            if(input) {
                input.onchange = (e) => {
                    if(e.target.files.length > 0) handleFiles(e.target.files, p);
                    e.target.value = ''; // Limpa input
                };
            }
        });

        function handleFiles(files, platform) {
            resultsPanel.style.display = 'flex';
            Array.from(files).forEach(file => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const wb = XLSX.read(new Uint8Array(e.target.result), { type: 'array' });
                    const rows = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]], { header: 1 });
                    
                    // Executa a estrat√©gia correta
                    if (strategies[platform]) {
                        const processedData = strategies[platform](rows);
                        renderBatch(processedData);
                    }
                };
                reader.readAsArrayBuffer(file);
            });
        }

        // --- Renderiza√ß√£o Otimizada (DocumentFragment) ---
        function renderBatch(dataList) {
            const fragment = document.createDocumentFragment();
            dataList.forEach(d => {
                const tr = document.createElement('tr');
                tr.setAttribute('data-plat', d.site);
                tr.innerHTML = `
                    <td>${d.site}</td>
                    <td>${d.id}</td>
                    <td>${formatNumber(d.prod)}</td>
                    <td>${formatNumber(d.frete)}</td>
                    <td>${formatNumber(d.total)}</td>
                    <td style="max-width:200px;overflow:hidden">${d.nome}</td>
                    <td>${d.status}</td>
                    <td>${d.cod}</td>
                    <td>${d.sku}</td>
                    <td>${formatNumber(d.liq)}</td>`;
                fragment.appendChild(tr);
            });
            dataTableBody.appendChild(fragment);
        }

        // --- Controles de UI ---
        document.getElementById('clearButton').onclick = () => { dataTableBody.innerHTML = ''; resultsPanel.style.display = 'none'; };
        
        document.getElementById('exportXLSButton').onclick = () => {
            const data = [["Site","ID","Prod","Frete","Total","Nome","Status","C√≥d","SKU","L√≠quido"]];
            Array.from(dataTableBody.rows).forEach(r => data.push(Array.from(r.cells).map(c => c.innerText.replace(/\n/g, ' '))));
            const ws = XLSX.utils.aoa_to_sheet(data);
            const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, "Dados");
            XLSX.writeFile(wb, "Processado_v11_5.xls");
        };

        const copyData = (plat) => {
            let text = "";
            const rows = plat ? dataTableBody.querySelectorAll(`tr[data-plat="${plat}"]`) : dataTableBody.rows;
            Array.from(rows).forEach(r => {
                const cells = Array.from(r.cells).slice(1).map(c => c.innerText.replace(/\n/g, ' '));
                text += cells.join('\t') + '\n';
            });
            navigator.clipboard.writeText(text);
            messageBox.innerText = "Copiado!";
            setTimeout(() => messageBox.innerText = "Pronto para processar.", 2000);
        };

        document.getElementById('copyAllButton').onclick = () => copyData(null);
        document.getElementById('copyShopeeButton').onclick = () => copyData('SH');
        document.getElementById('copyMercadoLivreButton').onclick = () => copyData('ML');
        document.getElementById('copyAmazonButton').onclick = () => copyData('AZ');
        document.getElementById('copyEstanteButton').onclick = () => copyData('EV');

        // Links
        const openTabs = (urls) => urls.forEach(url => window.open(url, '_blank'));
        document.getElementById('openSitesButton').onclick = () => openTabs(['https://seller.shopee.com.br/', 'https://www.mercadolivre.com.br/resumo/v2', 'https://sellercentral.amazon.com.br/', 'https://painel.estantevirtual.com.br/vendas']);
        document.getElementById('openSheetsButton').onclick = () => openTabs(['https://seller.shopee.com.br/portal/sale/order', 'https://www.mercadolivre.com.br/vendas/omni/lista', 'https://app.upseller.com/pt/order/to-ship', 'https://livreiro.estantevirtual.com.br/vendas']);
    });
</script>
</body>
</html>
